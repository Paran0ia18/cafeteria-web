<script>
    let usuarioAutenticado = null; // Variable para guardar el usuario autenticado

    // Función para manejar el inicio de sesión con Google
    async function signInWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            const result = await auth.signInWithPopup(provider);
            usuarioAutenticado = result.user; // Guardamos el usuario autenticado

            // Verificar el dominio del correo
            if (usuarioAutenticado.email.endsWith('@iesbendinat.org')) {
                alert('✅ Bienvenido, ' + usuarioAutenticado.displayName);
                document.getElementById('pedidoForm').style.display = 'block';
                document.getElementById('googleSignInBtn').style.display = 'none';
            } else {
                alert('❌ Solo se permite el inicio de sesión con correos de @iesbendinat.org');
                auth.signOut();
                usuarioAutenticado = null; // Asegurar que el usuario no quede registrado
                document.getElementById('googleSignInBtn').style.display = 'block';
            }
        } catch (error) {
            alert('❌ Error al iniciar sesión: ' + error.message);
        }
    }

    // Verificar el usuario al cambiar el estado de autenticación
    firebase.auth().onAuthStateChanged((user) => {
        if (user && user.email.endsWith('@iesbendinat.org')) {
            usuarioAutenticado = user;
            document.getElementById('pedidoForm').style.display = 'block';
            document.getElementById('googleSignInBtn').style.display = 'none';
        } else {
            usuarioAutenticado = null;
            auth.signOut();
            document.getElementById('pedidoForm').style.display = 'none';
            document.getElementById('googleSignInBtn').style.display = 'block';
        }
    });

    // Evento de inicio de sesión con Google
    document.getElementById('googleSignInBtn').addEventListener('click', signInWithGoogle);

    // Enviar pedido con validación de dominio
    document.getElementById('pedidoForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!usuarioAutenticado || !usuarioAutenticado.email.endsWith('@iesbendinat.org')) {
            alert('❌ No tienes permiso para enviar pedidos.');
            return; // Bloqueamos el envío
        }

        const nombre = document.getElementById('nombre').value;
        const curso = document.getElementById('curso').value;
        const clase = document.getElementById('clase').value;
        const pedido = document.getElementById('pedido').value;
        const precio = parseFloat(document.getElementById('precio').value);

        const fecha = new Date();
        const idPedido = fecha.toISOString().replace(/[-:]/g, '').replace('T', '_').split('.')[0];

        try {
            await db.collection('pedidos').doc(idPedido).set({
                nombre: nombre,
                curso: curso,
                clase: clase,
                pedido: pedido,
                precio: precio,
                fecha: fecha.toLocaleString(),
                usuario: usuarioAutenticado.email // Guardar el email en la base de datos
            });

            alert('✅ Pedido enviado correctamente');
            document.getElementById('pedidoForm').reset();
        } catch (error) {
            alert('❌ Error: ' + error.message);
        }
    });
</script>
